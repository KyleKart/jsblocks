<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>JS Blocks</title>
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
      font-family: sans-serif;
    }

    #menuBar {
      display: flex;
      background-color: #007acc;
      color: white;
      padding: 8px 12px;
      user-select: none;
    }

    #menuBar>div {
      margin-right: 20px;
      cursor: pointer;
    }

    #menuBar>div:hover {
      text-decoration: underline;
    }

    #blocklyDiv {
      flex: 1;
      width: 100%;
      position: relative;
    }

    #runButton {
      position: absolute;
      bottom: 10px;
      left: 10px;
      height: 40px;
      width: 80px;
      font-size: 18px;
      border: none;
      z-index: 1000;
      background-color: #007acc;
      color: white;
      cursor: pointer;
    }
  </style>
</head>

<body>

  <div id="menuBar">
    <div id="menuRun">Run</div>
    <div id="menuSave">Save</div>
    <div id="menuLoad">Load</div>
  </div>

  <div id="blocklyDiv"></div>

  <xml id="toolbox" style="display: none">
    <block type="js_hat"></block>
    <block type="js_cblock"></block>
    <block type="js_generic"></block>
  </xml>

  <script>
    Blockly.Blocks['js_generic'] = {
      init() {
        this.appendDummyInput()
          .appendField(new Blockly.FieldTextInput("console.log('Hello World!')"), "CODE");
        this.setPreviousStatement(true);
        this.setNextStatement(true);
        this.setColour(230);
      }
    };

    Blockly.Blocks['js_cblock'] = {
      init() {
        this.appendDummyInput()
          .appendField(new Blockly.FieldTextInput("if (true)"), "HEADER");
        this.appendStatementInput("DO");
        this.setPreviousStatement(true);
        this.setNextStatement(true);
        this.setColour(120);
      }
    };

    Blockly.Blocks['js_hat'] = {
      init() {
        this.appendDummyInput().appendField("Run");
        this.appendStatementInput("DO");
        this.setColour(300);
      }
    };

    const jsGen = Blockly.JavaScript;
    jsGen.forBlock = jsGen.forBlock || {};

    jsGen.forBlock['js_generic'] = (block) => {
      const code = block.getFieldValue('CODE') || '';
      return code ? code + ';\n' : '';
    };

    jsGen.forBlock['js_cblock'] = (block, generator) => {
      const header = block.getFieldValue('HEADER') || '';
      const body = generator.statementToCode(block, 'DO');
      return `${header} {\n${body}}\n`;
    };

    jsGen.forBlock['js_hat'] = (block, generator) => {
      return generator.statementToCode(block, 'DO');
    };

    const workspace = Blockly.inject('blocklyDiv', {
      toolbox: document.getElementById('toolbox'),
      trashcan: true,
      renderer: 'geras',
    });

    document.getElementById('menuRun').addEventListener('click', () => {
      let code = '';
      workspace.getTopBlocks(true).forEach(block => {
        if (block.type === 'js_hat') {
          code += jsGen.forBlock['js_hat'](block, jsGen);
        }
      });
      console.log('Generated JS:\n' + code);
      try { eval(code); } catch (e) { alert(e.message); }
    });

    document.getElementById('menuSave').addEventListener('click', () => {
      const jsonObj = Blockly.serialization.workspaces.save(workspace);
      const jsonText = JSON.stringify(jsonObj, null, 2);

      const filename = prompt("Enter filename to save:", "jblocks_workspace.json");
      if (!filename) return;

      const blob = new Blob([jsonText], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename.endsWith('.json') ? filename : filename + '.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    document.getElementById('menuLoad').addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = event => {
          try {
            const jsonObj = JSON.parse(event.target.result);
            workspace.clear();
            Blockly.serialization.workspaces.load(jsonObj, workspace);
          } catch (err) {
            alert("Error loading JSON: " + err.message);
            console.error("Error loading JSON:", err);
          }
        };

        reader.readAsText(file);
      };
      input.click();
    });
  </script>

</body>

</html>